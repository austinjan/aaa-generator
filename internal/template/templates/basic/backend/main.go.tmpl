package main

import (
	"embed"
	"fmt"
	"io/fs"
	"log"
	"net/http"
	"os"
)

//go:embed dist/*
var staticFiles embed.FS

func main() {
	port := os.Getenv("PORT")
	if port == "" {
		port = "{{.Port}}"
	}

	// API è·¯ç”±
	http.HandleFunc("/api/health", healthHandler)
	http.HandleFunc("/api/hello", helloHandler)

	// éœæ…‹æ–‡ä»¶æœå‹™
	distFS, err := fs.Sub(staticFiles, "dist")
	if err != nil {
		log.Fatal("Failed to create sub filesystem:", err)
	}

	// è¨­ç½®éœæ…‹æ–‡ä»¶æœå‹™å™¨
	fileServer := http.FileServer(http.FS(distFS))
	http.Handle("/", http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		// å¦‚æœè«‹æ±‚çš„æ˜¯ API è·¯ç”±ï¼Œä¸è™•ç†
		if r.URL.Path == "/" || r.URL.Path == "/static/" {
			fileServer.ServeHTTP(w, r)
			return
		}
		
		// SPA è·¯ç”±è™•ç† - æ‰€æœ‰é API è«‹æ±‚éƒ½è¿”å› index.html
		if !isStaticFile(r.URL.Path) && !isAPIRoute(r.URL.Path) {
			r.URL.Path = "/"
		}
		fileServer.ServeHTTP(w, r)
	}))

	fmt.Printf("ğŸš€ {{.ProjectName}} server starting on http://localhost:%s\n", port)
	fmt.Println("ğŸ“± Frontend: http://localhost:" + port)
	fmt.Println("ğŸ”— API Health: http://localhost:" + port + "/api/health")
	
	log.Fatal(http.ListenAndServe(":"+port, nil))
}

func healthHandler(w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json")
	w.Header().Set("Access-Control-Allow-Origin", "*")
	w.WriteHeader(http.StatusOK)
	w.Write([]byte(`{"status": "healthy", "service": "{{.ProjectName}}", "version": "1.0.0"}`))
}

func helloHandler(w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json")
	w.Header().Set("Access-Control-Allow-Origin", "*")
	w.WriteHeader(http.StatusOK)
	w.Write([]byte(`{"message": "Hello from {{.ProjectName}}!", "timestamp": "` + 
		fmt.Sprintf("%d", System.currentTimeMillis()) + `"}`))
}

func isStaticFile(path string) bool {
	staticExtensions := []string{".js", ".css", ".png", ".jpg", ".jpeg", ".gif", ".ico", ".svg", ".woff", ".woff2", ".ttf", ".eot"}
	for _, ext := range staticExtensions {
		if strings.HasSuffix(path, ext) {
			return true
		}
	}
	return false
}

func isAPIRoute(path string) bool {
	return strings.HasPrefix(path, "/api/")
}